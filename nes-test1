<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tiny jsnes demo</title>
  <style>
    canvas{image-rendering:pixelated;width:512px;height:480px;border:1px solid #333}
  </style>
</head>
<body>
  <h3>Tiny jsnes demo</h3>
  <input id="rom" type="file" accept=".nes" />
  <canvas id="screen" width="256" height="240"></canvas>

  <script src="https://unpkg.com/jsnes/dist/jsnes.min.js"></script>
  <script>
    const canvas = document.getElementById('screen');
    const ctx = canvas.getContext('2d');
    const imageData = ctx.createImageData(256, 240);
    const nes = new jsnes.NES({
      onFrame(frameBuffer) {
        let i=0, p=0;
        for (let y=0; y<240; y++) {
          for (let x=0; x<256; x++) {
            const r = frameBuffer[p++], g = frameBuffer[p++], b = frameBuffer[p++];
            imageData.data[i++] = r;
            imageData.data[i++] = g;
            imageData.data[i++] = b;
            imageData.data[i++] = 255;
          }
        }
        ctx.putImageData(imageData,0,0);
      }
    });

    document.getElementById('rom').addEventListener('change', async (e) => {
      const buf = await e.target.files[0].arrayBuffer();
      nes.loadROM(new Uint8Array(buf));
      const loop = () => { nes.frame(); requestAnimationFrame(loop); };
      loop();
    });
  </script>
</body>
</html>
